

# Modular Sysmon Deployment Framework for Splunk

> **Note:** This project was developed with the assistance of Google Gemini.

This project provides a robust, two-part framework for deploying and managing Sysmon across a Windows environment using a Splunk Deployment Server. The architecture is designed for scalability, maintainability, and clear separation of concerns.

## Core Architecture

The framework is split into two distinct Splunk Technical Add-ons (TAs) to separate software management from configuration management. Both TAs should be deployed to the same clients.

### 1. `TA-Sysmon-Binary` (The Installer)
This TA is responsible for the Sysmon software lifecycle.
- **Manages the `sysmon.exe` binary itself.**
- **Installs the Sysmon service** for the first time using a minimal, safe configuration.
- **Upgrades the Sysmon service** to a new version when you update the binary.
- **Handles uninstallation** and cleanup.
- This TA should be updated infrequently, only when a new version of Sysmon is released.

### 2. `TA-Sysmon-Config` (The Configurator)
This TA is responsible for the Sysmon configuration.
- **Manages the authoritative Sysmon configuration** (`config.xml`).
- **Periodically ensures** the running configuration on clients matches the one on the deployment server.
- **Contains your detailed, production-ready `config.xml`** with all your custom rules.
- This TA will be updated frequently, every time you want to change a monitoring rule.

---

## Getting Started

Follow these steps to set up the framework.

**1. Place the Sysmon Executable:**
- Download the latest version of Sysmon from [Sysinternals](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon).
- Place the `sysmon.exe` file into the following directory:
  ```
  TA-Sysmon-Binary/bin/sysmon.exe
  ```

**2. Set the Target Sysmon Version:**
- Open the following file in a text editor:
  ```
  TA-Sysmon-Binary/default/sysmon_version.conf
  ```
- Edit the `version` field to match the version of `sysmon.exe` you downloaded (e.g., `version = 15.15`).

**3. Define Your Primary Sysmon Configuration:**
- Open the following file:
  ```
  TA-Sysmon-Config/bin/config.xml
  ```
- This is your primary, authoritative configuration file. Customize it with all the rules and event filters you need for your environment. The included file provides a strong starting point.

**4. Deploy to Splunk:**
- Copy both the `TA-Sysmon-Binary` and `TA-Sysmon-Config` folders to your Splunk Deployment Server's deployment-apps directory (e.g., `etc/deployment-apps`).
- From the Splunk UI or CLI, assign both TAs to your desired Windows server classes.

---

## How to Use

### To Upgrade the Sysmon Version:
1.  Replace the `sysmon.exe` file in `TA-Sysmon-Binary/bin/`.
2.  Update the version number in `TA-Sysmon-Binary/default/sysmon_version.conf`.
3.  On your Splunk Deployment Server, reload the deployment server (`./splunk reload deploy-server` or use the UI).

### To Update the Sysmon Configuration:
1.  Edit your main configuration file: `TA-Sysmon-Config/bin/config.xml`.
2.  Reload the deployment server. The `TA-Sysmon-Config` app will be pushed to clients, and the new configuration will be applied.

---

## Logging & Troubleshooting

All deployment actions are logged on the client machines for troubleshooting. All logs are forwarded to Splunk into the `sysmon` index by default.

- **Installer/Upgrade Logs:** `C:\Windows\sysmon_installer.log`
  - Generated by `TA-Sysmon-Binary`.
- **Configuration Update Logs:** `C:\Windows\sysmon_config_updater.log`
  - Generated by `TA-Sysmon-Config`.
